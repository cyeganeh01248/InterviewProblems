import { getRandomColor, shadeColor, prng, usdfmt } from './tools.ts';
import React, { useEffect, useState } from 'react';
import { CartObj, ProductObj } from './objects.ts';
import * as sea from 'node:sea';

export function Products({
    cart,
    setCart,
    loggedIn,
}: {
    cart: CartObj;
    setCart: React.Dispatch<React.SetStateAction<CartObj>>;
    loggedIn: boolean;
}) {
    const [products, setProducts] = useState([] as { id: number }[]);
    const [search, setSearch] = useState('');
    useEffect(() => {
        fetch('/api/products?' + new URLSearchParams({ search }))
            .then((resp) => resp.json())
            .then((products) => {
                setProducts(products);
            });
    }, [search]);
    let rng = prng(124);
    let colors = [];
    for (let i = 0; i < products.length; i++) {
        colors.push(getRandomColor(rng));
    }
    return (
        <div id="all-products">
            <h2>Products</h2>
            <input
                placeholder="search"
                onChange={(e) => {
                    setSearch(e.target.value);
                }}
            />
            <hr />
            <div id="products">
                {products.map(({ id }, i) => (
                    <Product
                        key={id}
                        product={id}
                        loggedIn={loggedIn}
                        color={colors[i]}
                        setCart={setCart}
                    />
                ))}
            </div>
        </div>
    );
}
export function Product({
    product,
    color,
    setCart,
    loggedIn,
}: {
    product: number;
    color: string;
    setCart: React.Dispatch<React.SetStateAction<CartObj>>;
    loggedIn: boolean;
}) {
    const [clicked, setClicked] = useState(false);
    const [data, setData] = useState(new ProductObj(0, '', 0, 0, 0));
    useEffect(() => {
        fetch(`/api/product/${product}`)
            .then((resp) => resp.json())
            .then(setData);
    }, []);
    let content;
    if (!clicked)
        content = (
            <>
                <h3>{data.product_name}</h3>
                <img
                    src="data:image/svg+xml,%3Csvg%20viewBox%3D%220%200%201024%201024%22%20style%3D%22width%3A%201em%3B%20height%3A%201em%3Bvertical-align%3A%20middle%3Bfill%3A%20currentColor%3Boverflow%3A%20hidden%3B%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M726.534827%2056.661333l33.788586%2023.15264-161.928533%20236.291414-33.792-23.156054z%22%20fill%3D%22%23D6BB38%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M535.906987%20255.634773c17.199787-18.991787%2045.779627-29.36832%2065.580373-18.37056l32.750933%2020.165974c19.79392%2010.994347%2027.794773%2039.161173%2017.083734%2069.147306-13.626027%2023.95136-19.203413%2044.38016-61.3376%2021.183147l-32.873814-19.97824c-49.33632-27.938133-37.9392-52.80768-21.203626-72.147627z%22%20fill%3D%22%23D6BB38%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M420.05504%20559.104m-324.51584%200a324.51584%20324.51584%200%201%200%20649.03168%200%20324.51584%20324.51584%200%201%200-649.03168%200Z%22%20fill%3D%22%23CE1B60%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M420.05504%20904.09984c-190.231893%200-344.99584-154.763947-344.99584-344.992427%200-190.231893%20154.763947-344.99584%20344.99584-344.99584s344.99584%20154.763947%20344.99584%20344.99584c0%20190.22848-154.763947%20344.992427-344.99584%20344.992427z%20m0-649.028267c-167.645867%200-304.03584%20136.389973-304.03584%20304.03584%200%20167.642453%20136.389973%20304.032427%20304.03584%20304.032427s304.03584-136.389973%20304.03584-304.032427c0-167.645867-136.389973-304.03584-304.03584-304.03584z%22%20fill%3D%22%23B20055%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M184.896853%20672.641707a20.452693%2020.452693%200%200%201-19.268266-13.585067c-2.290347-6.423893-54.729387-158.849707%2063.218346-290.06848a20.48%2020.48%200%201%201%2030.464%2027.385173c-101.2736%20112.667307-57.01632%20243.469653-55.08096%20248.982187a20.50048%2020.50048%200%200%201-19.33312%2027.286187z%22%20fill%3D%22%23FFFFFF%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M293.19168%20335.274667m-23.538347%200a23.538347%2023.538347%200%201%200%2047.076694%200%2023.538347%2023.538347%200%201%200-47.076694%200Z%22%20fill%3D%22%23FFFFFF%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M640.003413%20667.275947m-288.457386%200a288.457387%20288.457387%200%201%200%20576.914773%200%20288.457387%20288.457387%200%201%200-576.914773%200Z%22%20fill%3D%22%23FFFFFF%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M640.003413%20976.213333c-170.349227%200-308.937387-138.591573-308.937386-308.937386%200-170.349227%20138.58816-308.937387%20308.937386-308.937387%20170.345813%200%20308.937387%20138.58816%20308.937387%20308.937387%200%20170.345813-138.591573%20308.937387-308.937387%20308.937386z%20m0-576.914773c-147.7632%200-267.977387%20120.214187-267.977386%20267.977387S492.240213%20935.253333%20640.003413%20935.253333s267.977387-120.214187%20267.977387-267.977386-120.214187-267.977387-267.977387-267.977387z%22%20fill%3D%22%23B20055%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M640.003413%20667.27936m-234.37312%200a234.37312%20234.37312%200%201%200%20468.74624%200%20234.37312%20234.37312%200%201%200-468.74624%200Z%22%20fill%3D%22%23FFE600%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M624.289257%20646.140227a19.83488%2028.84608%2058.937%201%200%2049.419131-29.768017%2019.83488%2028.84608%2058.937%201%200-49.419131%2029.768017Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M782.961137%20739.816559a19.828053%2028.84608%2058.937%201%200%2049.419132-29.768016%2019.828053%2028.84608%2058.937%201%200-49.419132%2029.768016Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M675.75896%20839.078492a28.84608%2019.83488%2072.476%201%200-17.371413-55.01472%2028.84608%2019.83488%2072.476%201%200%2017.371413%2055.01472Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M618.022547%20720.05817a28.84608%2019.831467%2072.476%201%200-17.371413-55.014719%2028.84608%2019.831467%2072.476%201%200%2017.371413%2055.014719Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M577.438306%20801.118102a19.831467%2028.84608%2058.937%201%200%2049.419131-29.768016%2019.831467%2028.84608%2058.937%201%200-49.419131%2029.768016Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M647.54202%20722.011713a28.84608%2019.83488%2037.112%201%200%2046.00705%2034.810008%2028.84608%2019.83488%2037.112%201%200-46.00705-34.810008Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M686.250581%20698.080153a19.828053%2028.842667%2019.56%201%200%2019.312692-54.356394%2019.828053%2028.842667%2019.56%201%200-19.312692%2054.356394Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M614.097733%20532.203076a19.83488%2028.842667%2019.554%201%200%2019.307-54.358417%2019.83488%2028.842667%2019.554%201%200-19.307%2054.358417Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M732.468629%20599.272529a19.828053%2028.84608%2058.937%201%200%2049.419131-29.768016%2019.828053%2028.84608%2058.937%201%200-49.419131%2029.768016Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M826.988837%20600.072598a19.831467%2028.84608%2017.296%201%200-17.152353%2055.08341%2019.831467%2028.84608%2017.296%201%200%2017.152353-55.08341Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M480.873513%20621.715961a19.83488%2028.84608%2017.296%201%200-17.152354%2055.08341%2019.83488%2028.84608%2017.296%201%200%2017.152354-55.08341Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M520.49171%20705.001737a28.842667%2019.831467%2070.726%201%200%2019.041125%2054.452119%2028.842667%2019.831467%2070.726%201%200-19.041125-54.452119Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M769.329267%20639.776399a19.831467%2028.84608%2017.296%201%200-17.152353%2055.083411%2019.831467%2028.84608%2017.296%201%200%2017.152353-55.083411Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M745.545276%20732.468444a28.842667%2019.83488%2081.228%201%200%208.79718%2057.01059%2028.842667%2019.83488%2081.228%201%200-8.79718-57.01059Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M529.216227%20782.979102a28.842667%2019.831467%2081.222%201%200%208.803149%2057.009668%2028.842667%2019.831467%2081.222%201%200-8.803149-57.009668Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M549.385631%20538.797884a19.831467%2028.84608%2017.296%201%200-17.152354%2055.08341%2019.831467%2028.84608%2017.296%201%200%2017.152354-55.08341Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M587.917709%20555.691439a28.84608%2019.83488%2029.634%201%200%2050.146122%2028.526335%2028.84608%2019.83488%2029.634%201%200-50.146122-28.526335Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M680.825488%20527.775375a28.84608%2019.831467%2074.235%201%200%2015.674522%2055.52202%2028.84608%2019.831467%2074.235%201%200-15.674522-55.52202Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M566.613315%20613.509947a19.828053%2028.849493%208.274%201%200-8.303297%2057.098409%2019.828053%2028.849493%208.274%201%200%208.303297-57.098409Z%22%20fill%3D%22%23D3A218%22%20transform%3D%22matrix(1%2C%200%2C%200%2C%201%2C%20-7.105427357601002e-15%2C%200)%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E"
                    alt="fruit"
                />
                <h4>{usdfmt(data.price / 100)}</h4>
            </>
        );
    else
        content = (
            <>
                <h3>{data.product_name}</h3>
                <h3>{usdfmt(data.price / 100)}</h3>
                <p>Stock: {data.stock}</p>
                {loggedIn ? (
                    <button
                        onClick={(e) => {
                            setCart((cart) => {
                                let items = cart.items;
                                items.push(data);
                                return new CartObj(items);
                            });
                        }}
                    >
                        Add to Cart
                    </button>
                ) : undefined}
            </>
        );
    return (
        <div
            className="product"
            style={{ background: color, color: shadeColor(color, 0.4) }}
            onClick={() => {
                setClicked(!clicked);
            }}
        >
            {content}
        </div>
    );
}
